# Data Contract: OHLCV

## 1. Назначение

Этот документ описывает **единый формат свечей OHLCV** и правила качества данных, принятые в проекте **Crypto Lab**.

Цель:

- чтобы любой модуль (загрузчик, QC, бэктестер, ресёрч-ноутбук) работал с **одинаково структурированными** данными;
- чтобы можно было формально проверять, что набор данных «годен для исследований/бэктестов».

---

## 2. Уровни данных

Различаем два уровня:

1. **Raw OHLCV**

   - данные, полученные от биржи и только минимально нормализованные (типы, названия колонок);
   - могут содержать пропуски, дубликаты, аномальные значения.

2. **Clean OHLCV**
   - данные, прошедшие QC по правилам этого контракта;
   - любые отклонения либо исправлены по задокументированным правилам, либо помечены (флаги).

В дальнейшем:

- loader пишет **raw**;
- QC-модуль проверяет raw и формирует **clean** + отчёт.

---

## 3. Базовая схема OHLCV

Каждая строка соответствует **одной свече**.

Обязательные поля:

| Поле        | Тип      | Описание                                           |
| ----------- | -------- | -------------------------------------------------- |
| `exchange`  | string   | Биржа (например, `binance`, `bybit`, `okx`).       |
| `symbol`    | string   | Инструмент в **uniform-формате**, см. ниже.        |
| `timeframe` | string   | Таймфрейм (`"1m"`, `"5m"`, `"1h"`, `"1d"` и т.п.). |
| `timestamp` | int / dt | Время **начала** свечи в миллисекундах UTC.        |
| `open`      | float64  | Цена открытия.                                     |
| `high`      | float64  | Максимальная цена.                                 |
| `low`       | float64  | Минимальная цена.                                  |
| `close`     | float64  | Цена закрытия.                                     |
| `volume`    | float64  | Объём (в базовой валюте, если не оговорено иначе). |

Опциональные поля (MVP может без них, но контракт сразу их резервирует):

| Поле           | Тип     | Описание                                                |
| -------------- | ------- | ------------------------------------------------------- |
| `trade_count`  | int64   | Количество сделок в свече (если отдаёт биржа).          |
| `quote_volume` | float64 | Объём в котируемой валюте (quote), если доступно.       |
| `is_partial`   | bool    | Флаг, что свеча неполная (например, последняя текущая). |

**Таймзона:**  
Все времена хранятся в **UTC**. Если используется тип `datetime`, он должен быть явно `UTC-aware`.

**Ключ уникальности строки:**  
Для Clean OHLCV не должно быть дубликатов по ключу:

```text
(exchange, symbol, timeframe, timestamp)
```

## 4.Формат symbol

Требование: иметь единый формат символов, независимо от биржи.

- Базовый формат для спот-рынка: BASE/QUOTE, например:
  - BTC/USDT
  - ETH/USDT
- Для деривативов (фьючи, перпы) можно зафиксировать расширенный формат, например:
  - BTC/USDT:PERP или BTC/USDT:USDTFUT (детали можно уточнить позже, но важно единообразие).

Правило:
**Loader обязан маппить нативный символ биржи** к единому symbol по внутренним правилам (отдельный mapping-слой).

## 5. Правила по таймфреймам и времени

### 5.1 Старт свечи

- timestamp — это начало интервала свечи.
- Длительность интервала определяется timeframe:
  - 1m → 60 секунд;
  - 5m → 300 секунд;
  - 1h → 3600 секунд;

### 5.2 Равномерная сетка времени

Для **Clean OHLCV:**

- последовательность timestamp для заданных (exchange, symbol, timeframe) должна образовывать равномерную сетку;
- разность между соседними свечами строго равна длине таймфрейма.

Если есть проломы (пропущенные свечи):

- raw может содержать дырки;
- QC обязан их обнаружить и отразить в отчёте.

## 6. Правила валидности цен и объёмов

Для каждой свечи уровня Clean действуют следующие правила:

1. Неотрицательные значения:
   - open, high, low, close, volume ≥ 0;
   - если биржа отдаёт 0 или отрицательные цены — это считается аномалией.
2. Соотношение high / low:
   - low <= min(open, close);
   - high >= max(open, close);
   - low <= high.
3. Максимальная амплитуда (опционально, можно включить позже):

- Если относительное изменение за свечу (например, high / low) превышает некоторый порог (например, 5×), свеча помечается как аномальная (см. QC-флаги).

4. Объём:
   - volume >= 0;
   - при volume == 0 свеча возможна, но это может быть отдельным индикатором низкой активности.

## 7. Пропуски, дубликаты, «дырки» в данных

### 7.1. Пропущенные свечи

Пропуск свечи определяется как **отсутствие timestamp в ожидаемой сетке**.

В рамках MVP:

- Clean OHLCV не обязан автоматически заполнять пропуски, но:
  - QC должен показать их количество и интервалы;
  - в отчёте QC фиксируется, что набор содержит пропуски.

Возможные политики будущего: - оставлять дырки как есть; - добавлять «пустые» свечи с open=close=high=low=предыдущая_цена, volume=0 и флагом is_synthetic = True.

Политика, выбранная для конкретного набора, должна быть зафиксирована в отчёте QC.

### 7.2. Дубликаты

- В Clean OHLCV не допускаются дубликаты по ключу `(exchange, symbol, timeframe, timestamp)`
- При обнаружении нескольких свечей с одинаковым ключом:
  - raw-данные сохраняются как есть;
  - QC:
    - либо помечает набор как невалидный;
    - либо применяет заранее описанное правило (например, брать последнюю свечу).

## 8. Аномалии (edge cases)

QC-модуль должен уметь помечать следующие типы аномалий:

1. Невалидные цены:

   - low > high;
   - high == 0 при ненулевых open/close и др.

2. Слишком резкие скачки:

- относительный диапазон свечи high/low превышает заданный порог;
- относительное изменение close к предыдущему close превышает заданный порог.

3. Ненормальный объём:

- volume в несколько раз больше/меньше «нормы» (по статистике).

На уровне контракта достаточно зафиксировать, что:

- аномалии не обязательно вызывают удаление свечи, но должны быть:
  - либо помечены флагами;
  - либо отражены в QC-отчёте (число аномалий, доля от выборки).

## 9. QC-флаги (дополнительные поля)

Для Clean OHLCV допускается добавление специальных флагов — логических полей, которые показывают состояние данных после проверок качества. Эти флаги не являются обязательными, но контракт резервирует их использование для модулей QC.

Рекомендуемые QC-флаги:

- **`qc_missing_prev`** — `True`, если перед данной свечой обнаружена пропущенная свеча в ожидаемой равномерной сетке времени.
- **`qc_anomaly_price`** — `True`, если свеча была помечена как аномальная по ценам (например, `low > high`, экстремальный скачок).
- **`qc_anomaly_volume`** — `True`, если обнаружена аномалия по объёму (слишком большой или слишком маленький относительно соседних свеч).
- **`qc_duplicate_resolved`** — `True`, если свеча появилась в результате разрешения дубликата (например, если в raw-данных было два значения с одинаковым timestamp).

Флаги позволяют анализировать качество данных, строить отчёты QC и фильтровать проблемные свечи в исследованиях.

## 10. Хранение и формат файлов

Рекомендуемый формат хранения данных — **Parquet** (эффективный по размеру, сжатый, хорошо интегрируется с pandas и pyarrow).

Базовая структура каталогов для Clean OHLCV:

```
data/clean/
  {exchange}/
    {symbol}/
      {timeframe}.parquet
```

Примеры:

```
data/clean/binance/BTC-USDT/1m.parquet
data/clean/binance/ETH-USDT/1h.parquet
```
